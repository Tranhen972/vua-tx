{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Quan Ly Thanh Vien</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <form class="d-flex" action="/admin/users" method="get">
            <input class="form-control me-2" type="search" placeholder="Tim ID..." name="q"
                value="{{ request.args.get('q', '') }}">
            <button class="btn btn-outline-primary" type="submit">Tim</button>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>So Du</th>
                    <th>Nap/Rut</th>
                    <th>Cuoc & Bank</th>
                    <th>VIP</th>
                    <th>Trang Thai</th>
                    <th>Hanh Dong</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u['user_id'] }}</td>
                    <td class="fw-bold text-success">{{ '{:,}'.format(u['balance']) }}</td>
                    <td>
                        <small class="text-success">N: {{ '{:,}'.format(u['total_deposit']) }}</small><br>
                        <small class="text-danger">R: {{ '{:,}'.format(u['total_withdraw']) }}</small>
                    </td>
                    <td>
                        <small>Cuoc: <span class="fw-bold">{{ '{:,}'.format(u['current_bet']) }}</span> / {{
                            '{:,}'.format(u['required_wager']) }}</small><br>
                        {% if u['bank_info'] and u['bank_info'].get('bank') %}
                        <small class="text-primary">{{ u['bank_info']['bank'] }} - {{ u['bank_info']['stk']
                            }}</small><br>
                        <small class="text-muted">{{ u['bank_info']['ctk'] }}</small>
                        {% else %}
                        <small class="text-muted">Chua lien ket</small>
                        {% endif %}
                    </td>
                    <td><span class="badge bg-secondary">LV {{ u['vip_level'] }}</span></td>
                    <td>
                        {% if u.get('banned_until') %}
                        <span class="badge bg-danger">BANNED</span>
                        {% else %}
                        <span class="badge bg-success">Active</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="/admin/user/{{ u['user_id'] }}/details" class="btn btn-sm btn-secondary"
                                title="ChiÌ‰ TiÃªÌt Giao DiÌ£ch & LiÌ£ch SÆ°Ì‰">ðŸ“œ Chi Tiáº¿t</a>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                data-bs-target="#balanceModal{{ u['user_id'] }}">$ So Du</button>


                            {% if u.get('banned_until') %}
                            <form action="/admin/user/{{ u['user_id'] }}/unban" method="post" class="d-inline"
                                onsubmit="return confirm('Mo khoa user nay?')">
                                <button type="submit" class="btn btn-sm btn-success">Unban</button>
                            </form>
                            {% else %}
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                data-bs-target="#banModal{{ u['user_id'] }}">Ban</button>
                            {% endif %}
                            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                data-bs-target="#editModal{{ u['user_id'] }}">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal"
                                data-bs-target="#msgModal{{ u['user_id'] }}">
                                <i class="bi bi-chat-dots"></i> Nháº¯n
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Message Modal -->
                <div class="modal fade" id="msgModal{{ u['user_id'] }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/admin/user/{{ u['user_id'] }}/message" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title">Nhan Tin Cho: {{ u['user_id'] }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Noi Dung:</label>
                                        <textarea name="message" class="form-control" rows="3" required></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Gui Tin Nhan</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Balance Modal -->
                <div class="modal fade" id="balanceModal{{ u['user_id'] }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/admin/user/{{ u['user_id'] }}/adjust_balance" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title">Chinh So Du: {{ u['user_id'] }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>So du hien tai: <strong>{{ '{:,}'.format(u['balance']) }}</strong></p>
                                    <div class="mb-3">
                                        <label class="form-label">So tien (Nhap so am de tru):</label>
                                        <input type="number" name="amount" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ly do:</label>
                                        <input type="text" name="reason" class="form-control"
                                            placeholder="Vd: Nap bu, Tru gian lan...">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Xac Nhan</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Edit Info Modal -->
                <div class="modal fade" id="editModal{{ u['user_id'] }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/admin/user/{{ u['user_id'] }}/edit_info" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title">Chinh Thong Tin: {{ u['user_id'] }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">VIP Level:</label>
                                        <input type="number" name="vip_level" class="form-control"
                                            value="{{ u['vip_level'] }}" min="0" max="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Yeu Cau Cuoc (VND):</label>
                                        <input type="number" name="required_wager" class="form-control"
                                            value="{{ u.get('required_wager', 0) }}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ti Le Thang (%):</label>
                                        <input type="number" name="win_rate" class="form-control"
                                            value="{{ u.get('win_rate', -1) }}" min="-1" max="100">
                                        <div class="form-text">Nhap -1 de dung mac dinh he thong.</div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Luu Thong Tin</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Ban Modal -->
                <div class="modal fade" id="banModal{{ u['user_id'] }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/admin/user/{{ u['user_id'] }}/ban" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title">Khoa User: {{ u['user_id'] }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Thoi Gian (gio):</label>
                                        <input type="number" name="hours" class="form-control" value="87600">
                                        <div class="form-text">Mac dinh 10 nam (87600 gio).</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ly do:</label>
                                        <input type="text" name="reason" class="form-control" required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-danger">Xac Nhan Khoa</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav class="d-flex justify-content-center mt-3">
        <ul class="pagination">
            {% if page > 1 %}
            <li class="page-item"><a class="page-link"
                    href="?page={{ page-1 }}&q={{ request.args.get('q', '') }}">Previous</a></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">Page {{ page }} / {{ total_pages }}</span></li>
            {% if page < total_pages %} <li class="page-item"><a class="page-link"
                    href="?page={{ page+1 }}&q={{ request.args.get('q', '') }}">Next</a></li>
                {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}